{"is_source_file": true, "format": "JavaScript", "description": "This file implements the PaymentService class, providing methods to handle various payment operations including initialization, processing callbacks, refunds, and payment history retrieval, integrating with Vipps and credit balances, and interacting with a database.", "external_files": ["../config/database", "../config/config", "axios"], "external_methods": ["query", "transaction"], "published": ["PaymentService"], "classes": [{"name": "PaymentService", "description": "Class providing payment-related services such as initialization, callback processing, refunds, and payment history retrieval, with integration to Vipps and credit system."}], "methods": [{"name": "initializeVippsPayment(userId, amount, description, bookingId = null)", "description": "Initializes a Vipps payment, creating a payment record and obtaining a Vipps payment URL.", "scope": "PaymentService", "scopeKind": "class"}, {"name": "processVippsCallback(orderId, callbackData)", "description": "Processes the callback from Vipps indicating payment status change.", "scope": "PaymentService", "scopeKind": "class"}, {"name": "processCreditPayment(userId, amount, description, bookingId)", "description": "Processes payment via user credits, updating balances accordingly.", "scope": "PaymentService", "scopeKind": "class"}, {"name": "processRefund(paymentId, refundAmount, reason)", "description": "Processes refunds for completed payments, handling both Vipps and credit methods.", "scope": "PaymentService", "scopeKind": "class"}, {"name": "getUserPaymentHistory(userId, limit = 20, offset = 0)", "description": "Retrieves the payment history for a user, with optional pagination.", "scope": "PaymentService", "scopeKind": "class"}, {"name": "getVippsAccessToken()", "description": "Retrieves an access token from Vipps for API calls.", "scope": "PaymentService", "scopeKind": "class"}, {"name": "getVippsPaymentDetails(orderId, accessToken)", "description": "Fetches payment details from Vipps for a given order ID.", "scope": "PaymentService", "scopeKind": "class"}, {"name": "getUserPhoneNumber(userId)", "description": "Fetches the user's phone number from the database for Vipps payment setup.", "scope": "PaymentService", "scopeKind": "class"}], "calls": ["axios.post", "axios.get", "client.query", "transaction (method)"], "search-terms": ["Vipps payment", "paymentService", "initializeVippsPayment", "processVippsCallback", "Credit payment", "refund", "payment history", "paymentMethod", "external_payment_id", "getVippsAccessToken", "user_phone_number"], "state": 2, "file_id": 23, "knowledge_revision": 47, "git_revision": "", "ctags": [{"_type": "tag", "name": "PaymentService", "path": "/home/kavia/workspace/code-generation/nordic-carpool-platform-89320-89331/blablabil_backend/src/services/paymentService.js", "pattern": "/^class PaymentService {$/", "language": "JavaScript", "kind": "class"}, {"_type": "tag", "name": "axios", "path": "/home/kavia/workspace/code-generation/nordic-carpool-platform-89320-89331/blablabil_backend/src/services/paymentService.js", "pattern": "/^const axios = require('axios');$/", "language": "JavaScript", "kind": "constant"}, {"_type": "tag", "name": "config", "path": "/home/kavia/workspace/code-generation/nordic-carpool-platform-89320-89331/blablabil_backend/src/services/paymentService.js", "pattern": "/^const config = require('..\\/config\\/config');$/", "language": "JavaScript", "kind": "constant"}, {"_type": "tag", "name": "exports", "path": "/home/kavia/workspace/code-generation/nordic-carpool-platform-89320-89331/blablabil_backend/src/services/paymentService.js", "pattern": "/^module.exports = new PaymentService();$/", "language": "JavaScript", "kind": "variable", "scope": "module", "scopeKind": "class"}, {"_type": "tag", "name": "getUserPaymentHistory", "path": "/home/kavia/workspace/code-generation/nordic-carpool-platform-89320-89331/blablabil_backend/src/services/paymentService.js", "pattern": "/^  async getUserPaymentHistory(userId, limit = 20, offset = 0) {$/", "language": "JavaScript", "kind": "method", "signature": "(userId, limit = 20, offset = 0)", "scope": "PaymentService", "scopeKind": "class"}, {"_type": "tag", "name": "getUserPhoneNumber", "path": "/home/kavia/workspace/code-generation/nordic-carpool-platform-89320-89331/blablabil_backend/src/services/paymentService.js", "pattern": "/^  async getUserPhoneNumber(userId) {$/", "language": "JavaScript", "kind": "method", "signature": "(userId)", "scope": "PaymentService", "scopeKind": "class"}, {"_type": "tag", "name": "getVippsAccessToken", "path": "/home/kavia/workspace/code-generation/nordic-carpool-platform-89320-89331/blablabil_backend/src/services/paymentService.js", "pattern": "/^  async getVippsAccessToken() {$/", "language": "JavaScript", "kind": "method", "signature": "()", "scope": "PaymentService", "scopeKind": "class"}, {"_type": "tag", "name": "getVippsPaymentDetails", "path": "/home/kavia/workspace/code-generation/nordic-carpool-platform-89320-89331/blablabil_backend/src/services/paymentService.js", "pattern": "/^  async getVippsPaymentDetails(orderId, accessToken) {$/", "language": "JavaScript", "kind": "method", "signature": "(orderId, accessToken)", "scope": "PaymentService", "scopeKind": "class"}, {"_type": "tag", "name": "initializeVippsPayment", "path": "/home/kavia/workspace/code-generation/nordic-carpool-platform-89320-89331/blablabil_backend/src/services/paymentService.js", "pattern": "/^  async initializeVippsPayment(userId, amount, description, bookingId = null) {$/", "language": "JavaScript", "kind": "method", "signature": "(userId, amount, description, bookingId = null)", "scope": "PaymentService", "scopeKind": "class"}, {"_type": "tag", "name": "processCreditPayment", "path": "/home/kavia/workspace/code-generation/nordic-carpool-platform-89320-89331/blablabil_backend/src/services/paymentService.js", "pattern": "/^  async processCreditPayment(userId, amount, description, bookingId) {$/", "language": "JavaScript", "kind": "method", "signature": "(userId, amount, description, bookingId)", "scope": "PaymentService", "scopeKind": "class"}, {"_type": "tag", "name": "processRefund", "path": "/home/kavia/workspace/code-generation/nordic-carpool-platform-89320-89331/blablabil_backend/src/services/paymentService.js", "pattern": "/^  async processRefund(paymentId, refundAmount, reason) {$/", "language": "JavaScript", "kind": "method", "signature": "(paymentId, refundAmount, reason)", "scope": "PaymentService", "scopeKind": "class"}, {"_type": "tag", "name": "processVippsCallback", "path": "/home/kavia/workspace/code-generation/nordic-carpool-platform-89320-89331/blablabil_backend/src/services/paymentService.js", "pattern": "/^  async processVippsCallback(orderId, callbackData) {$/", "language": "JavaScript", "kind": "method", "signature": "(orderId, callbackData)", "scope": "PaymentService", "scopeKind": "class"}], "hash": "524329182bb3f515dcdf67d6a768bd46", "format-version": 4, "code-base-name": "blablabil_backend", "filename": "blablabil_backend/src/services/paymentService.js", "fields": [{"name": "module.exports = new PaymentService();", "scope": "module", "scopeKind": "class", "description": "unavailable"}], "revision_history": [{"47": ""}]}